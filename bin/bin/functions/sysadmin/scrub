#!/usr/bin/bash
# sdothum - 2016 (c) wtfpl

# Sysadmin
# ══════════════════════════════════════════════════════════════════════════════

# .......................................................... Btrfs scrub wrapper

# 1am monthly /net scrub
# crontab: 0 1 1 * * <path>/scrub share >>/tmp/scrub.log 2>&1

usage() { 
  echo "usage: $(basename $0) a'll | boot | root | net | share | backup"
  echo "       $(basename $0) c'ancel | s'tatus [<minutes>] | I'nitialize  [boot | root | net | share | backup]"
  exit 1
}

interval=300     # default 5 minute interval reporting
CRON=/tmp/scrub  # see crontab -l

# import user path
[ -e $CRON ] && . $HOME/bin/functions/shell/user_path colors  # bash shell required for cron colors

# butterfs maintenance
volume() {
  case $@ in
  boot  ) echo /boot ;;
  root  ) echo /boot ;;
  net   ) echo /net ;;
  share ) echo /net ;;
  backup) echo /backup ;;
  *     ) echo $@ ;;
  esac
}

show() {
  V=$(volume $@)
  [ $V ] || usage
  [ $interval -eq 0 ] && usage
  ditto status "every $(( $interval / 60 )) minutes"
  pgrep -f "btrfs scrub start -Bd $V" >/dev/null || in_progress=$@
  while : ;do
    trace "$@"
    sudo btrfs scrub status $V
    pgrep -f "btrfs scrub start -Bd $V" >/dev/null || break
    sleep $interval
  done
  [ $in_progress ] || press_enter
  notify X critical "btrfs scrub $V" "$(sudo btrfs scrub status $V | grep summary | sed -r 's/.*: *//g; s/^(.)/\u\1/')"
  rm -f $CRON
}

case $1 in
'') usage ;;
a*) scrub boot; scrub share; scrub backup ;;
c*) sudo btrfs scrub cancel $(volume $2) ;;
I*) sudo rm -f /var/lib/btrfs/*.* ;;
s*) [ $3 ] && { interval=$(( $2 * 60 )); shift; }; show $(volume $2) ;;

* ) nohup sudo btrfs scrub start -Bd $(volume $@) >/dev/null 2>&1 &
    pstat Xorg && [ ! -e $CRON ] && (term "$@" "scrub s $@" &) || scrub s $@ ;;
esac

# vim: set ft=sh: #
