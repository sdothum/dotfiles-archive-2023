#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# X11 Server
# ══════════════════════════════════════════════════════════════════════════════

# ${COLORS} defined in env

# ............................................................... Window manager

usage() { echo "usage: $(basename $0) 'start | 2bwm | awesome | bspwm | budgie | cinnamon | dwm | gnome | goomwwm | guile | herbstluftwm | i3 | kde | lxde | lxqt | notion | openbox | ratpoison | razor-qt | spectrwm | stumpwm | subtle | shell | windowchef | wmii | wmutils | wtftw | xfce4 | xmonad"; rm -f $BOOTWM; exit 1; }

BOOTWM=$SESSION/boot:wm  # see console_login, user_login
WM=$HOME/.windowmanager

# sh -c 'cd /usr/share/figlet; for i in *tlf ;do toilet -F gay -f $i $(cat $WM); echo $i; read prompt ;done'
font=pagga
font=future
font=emboss

# see .xinitrc
case $1 in
abort | halt | stop ) [ -e $BOOTWM ] && ditto user_login 'canceling startx'; rm -f $BOOTWM; exit ;;  # boot intercept shortcut
''  ) ;;
2b* ) echo 2bwm >$WM ;;
aw* ) echo awesome >$WM ;;
bs* ) echo bspwm >$WM ;;
bu* ) echo budgie >$WM ;;
ci* ) echo cinnamon >$WM ;;
dw* ) echo dwm >$WM ;;
gn* ) echo gnome >$WM ;;
go* ) echo goomwwm >$WM ;;
gu* ) echo guile >$WM ;;
he* ) echo herbstluftwm >$WM ;;
i3  ) echo i3 >$WM ;;
kde ) echo kde >$WM ;;
le* ) echo leftwm >$WM ;;
lxd*) echo lxde >$WM ;;
lxq*) echo lxqt >$WM ;;
ma* ) echo mate >$WM ;;
no* ) echo notion >$WM ;;
op* ) echo openbox >$WM ;;
rat*) echo ratpoison >$WM ;;
raz*) echo razor-qt >$WM ;;
sp* ) echo spectrwm >$WM ;;
st* ) echo stumpwm >$WM ;;
su* ) echo subtle >$WM ;;
sh* ) echo shell >$WM ;;
wi* ) echo windowchef >$WM ;;
wmi*) echo wmii >$WM ;;
wmu*) echo wmutils >$WM ;;
wt* ) echo wtftw >$WM ;;
xf* ) echo xfce4 >$WM ;;
xm* ) echo xmonad >$WM ;;
*   ) usage ;;
esac

# start X11 from init console
if console ;then
  wm=$(cat $WM)
  [ ${#wm} -le 12 ] && extra=' '  # emboss spacing
  [ $font = emboss ] && seat=$(echo $wm | sed -r "s/(.)/\1 $extra/g; s/ *$//") || seat=$wm
  void && toilet -F gay -f $font "$seat" || toilet -F rainbow -f $font "$seat"
  echo
  sleep 1
  [ $wm = shell ] && exit  # escape to shell prompt

  if [ -f $HOME/.mount-nfs ] ;then
    if [ ! -d /net/depot/dotfiles ] ;then
      sudo mount /net
      sudo mount $HOME/Maildir
      touch /tmp/mount:nfs
    fi
  fi

  pstat startx && exit
  cpu arm && { tmout ifyes 'sync with watchman' && wsync || wsync -s; }
  # mount any dangling nfs shares
  # sudo mount -a
  startx -- 2>/tmp/startx:x.log

  # suppress nfs messages to console when server is offline
  if [ -f /tmp/mount:nfs ] ;then
    sudo umount /net
    sudo umount $HOME/Maildir
    rm -f /tmp/mount:nfs
  fi

  # session specific clean up
  pkill -KILL $wm
  case $wm in
  2b* ) ;;
  aw* ) ;;
  bs* ) ;;
  bu* ) ;;
  ci* ) ;;
  dw* ) ;;
  gn* ) ;;
  go* ) ;;
  gu* ) ;;
  he* ) ;;
  i3  ) ;;
  kde ) ;;
  le* ) ;;
  lxd*) ;;
  lxq*) ;;
  ma* ) ;;
  no* ) ;;
  op* ) ;;
  rat*) ;;
  raz*) ;;
  sp* ) ;;
  st* ) ;;
  su* ) ;;
  sh* ) ;;
  wi* ) ;;
  wmi*) ;;
  wmu*) ;;
  wt* ) ;;
  xf* ) ;;
  xm* ) ;;
  esac

  # rare dangling instances..
  killall -KILL qutebrowser 2>/dev/null
  killall -KILL weechat 2>/dev/null 

  cpu arm && { pstat syncthing || { tmout ifno 'sync with syncthing' || wsync -s; } }
else
  # already in X11 session
  ditto 'window manager' "$(cat $WM) (next X session)"
fi

# vim: set ft=sh: #
