# sdothum - 2016 (c) wtfpl

# Make
# ══════════════════════════════════════════════════════════════════════════════

# ...................................................................... iosevka

usage() { 
  echo "usage: $(basename $0) iosevka [kindle | kobo | ebook | web] [family <name>]
                            [myfonts | elementary | grotesk | D-serifless | I-serifless | J-descending | [e|g]Q-[bar|straight] | Q-[crossing|detached|hook|straight] | a-single | b-rounded | d-[tailed|toothless] | f-extended | p-[eared|serifed] | q-hook | at-tall | 0-split | paren-flat | [cap off | <parm>] | space <parm> | book+regular | latin+greek]*
                            [[version 10x | 15x] -- <opions>*]"
  exit 1
}

# e.g. with optional glyph variants..
#        make_install iosevka kobo                                               # default kobo fonts
#        make_install iosevka kobo a-single f-extended I-serifless family aFont  # custom e-ink font
#        make_install iosevka                                                    # default desktop fonts
#        make_install iosevka Q-bar                                              # default desktop fonts
#        make_install iosevka grotesk                                            # grotesk style desktop fonts
#        make_install iosevka elementary                                         # elementary style desktop fonts
#        make_install iosevka kobo latin+greek myfonts space 1.5000 eQ-bar       # my custom e-reader fonts
#        make_install iosevka -- I-serifless family forCoding                    # single custom font, see font/iosevka
#        make_install iosevka version 10x -- dyslexic kobo english I-serifless f-extended q-hook cap extended family Grotesk  # single custom ebook font with extended cap height

MAKE_INSTALL=/tmp/iosevka:make_install
# SRCDIR=$HOME/bin/functions/font
DEPOT=/net/depot
GLYPH=b-rounded
cap='cap extended'  # new make_install default, "cap off" to disable
dyslexic=true       # default e-reader dyslexic font families

touch $MAKE_INSTALL
trap "rm -f $MAKE_INSTALL; pkill -f iosevka" EXIT INT 
shift

glyph() { unset b d p; eval $1=$2; GLYPH=$2; }

version() {
  # [ -L $SRCDIR/iosevka ] && rm -f $SRCDIR/iosevka
  [ -L $DEPOT/Iosevka ]  && rm -f $DEPOT/Iosevka
  # ln -s $SRCDIR/iosevka.$1 $SRCDIR/iosevka || usage
  ln -s $DEPOT/Iosevka.$1  $DEPOT/Iosevka  || usage
}

while [ $1 ] ;do
  case $1 in
  D-serifless ) D=$1 ;;
  I-serifless ) I=$1 ;;        # source code variant
  J-descending) J=$1 ;;
  eQ-bar      ) eQ=${1#?} ;;   # elementary/Geolexic font variation
  gQ-bar      ) gQ=${1#?} ;;   # grotesk/Unolexic font variation
  eQ-straight ) eQ=${1#?} ;;   # elementary/Geolexic font variation
  gQ-straight ) gQ=${1#?} ;;   # grotesk/Unolexic font variation
  Q-bar       ) Q=$1 ;;
  Q-crossing  ) Q=$1 ;;
  Q-detached  ) Q=$1 ;;
  Q-hook      ) Q=$1 ;;
  Q-straight  ) Q=$1 ;;
  a-single    ) a=$1 ;;
  b-rounded   ) glyph b $1 ;;  # unolexic
  d-tailed    ) glyph d $1 ;;  # ebook variant
  d-toothless ) glyph d $1 ;;  # with p-eared
  f-extended  ) f=$1 ;;        # unolexic (homage to universal grotesk)
  p-eared     ) glyph p $1 ;;
  p-serifed   ) glyph p $1 ;;
  q-hook      ) q=$1 ;;        # ebook variant
  at-tall     ) at=$1 ;;       # source code variant
  0-split     ) zero=$1 ;;
  paren-flat  ) paren=$1 ;;    # source code variant
  book+regular) adjust=$1 ;;
  latin+greek ) language=$1 ;;
  cap         ) [ $2 ] && { [ $2 = 'off' ] && unset cap || cap="$1 $2"; shift; } || usage ;;
  space       ) [ $2 ] && { space="$1 $2"; shift; } || usage ;;
  source-only ) source_only=true ;;
  myfonts     ) unset dyslexic ;;              # my elementary and grotesk fonts with tweaked space cell width
  elementary  ) style=$1 ;;
  grotesk     ) style=$1 ;;
  kindle      ) ereader=$1; sb='sb 0.6150' ;;  # side bearing difference to kobo's font rendering
  kobo        ) ereader=$1; q=q-hook ;;
  family      ) [ $ereader ] && [ $2 ] && { family=$2; shift; } || usage ;;
ebook       ) ebook=true ;;
  web         ) web=true ;;
  version     ) [ $2 ] && { version $2; shift; } || usage ;;
  --          ) shift; . $HOME/bin/functions/font/iosevka $@; exit ;;
  *           ) usage ;;
  esac
  shift
done

# build font suite
ifno 'build iosevka font suite' && exit

update() {
  fonts='*-book *-bookitalic *-bold *-bolditalic'
  cd $HOME/.fonts/$2

  for i in $fonts ;do
    # supplementary glyphs (as uncovered from ebooks)
    fforge map $i 2e22 300c  # add corner bracket punctuation
    fforge map $i 2e25 300d
    # e-reader font folders
    file=$i.ttf
    folder=$STOW/$ereader/fonts/$1
    mkdir -p $folder
    cp -v $file $folder/
  done
}

options() { echo $D $I $J $Q $a $b $d $f $p $q $zero $at $paren $adjust $cap $sb $style $@; }  # list

# family [options]*
e_ink() {
  name=$1
  shift
  iosevka dyslexic $ereader ${language:-english} $(options $@) $space family $name
  update $GLYPH $name
}

dfont() { iosevka expanded at-tall Q-bar $(options $@) q-hook; }
wfont() { iosevka english          Q-bar $(options $@) q-hook asterisk-high; }  # override dyslexic "asterisk-low"
efont() { iosevka ${language:-english}   $(options $@) q-hook; }

if [ $family ] ;then
  version 10x
  # custom e-ink font (non-published)
  e_ink $family

elif [ $ereader ] && [ $dyslexic ] ;then
  version 10x
  # e-ink fonts (dyslexic default)
  e_ink iMonolexic
  e_ink Monolexic   I-serifless
  e_ink iUnolexic   f-extended $gQ
  e_ink Unolexic    f-extended $gQ I-serifless
  e_ink iGeolexic   a-single   $eQ
  e_ink Geolexic    a-single   $eQ I-serifless

elif [ $ereader ] ;then
  version 10x
  # special spacing
  gQ=Q-straight
  e_ink igrotesk    f-extended cap extended $gQ ${space:-space 1.6667}
  e_ink grotesk     f-extended cap extended $gQ I-serifless ${space:-space 1.6667}
  eQ=Q-straight
  e_ink ielementary a-single   cap extended $eQ ${space:-space 1.6667}
  e_ink elementary  a-single   cap extended $eQ I-serifless ${space:-space 1.6667}

elif [ $ebook ] ;then
  version 10x
  # e-reader fonts
  efont ebook
  efont ebook    I-serifless
  efont ebook    quasi-proportional
  efont ebook    quasi-proportional I-serifless
  efont dyslexic quasi-proportional
  efont dyslexic quasi-proportional I-serifless

elif [ $web ] ;then
  version 10x
  # www fonts
  unset cap
  wfont heading  kobo webfont
  wfont dyslexic f-extended cap 1.045 space 1.515 kobo webfont
  # wfont dyslexic a-single cap 1.045 space 1.515 kobo webfont
  wfont dyslexic quasi-proportional   space 1.25  kobo webfont
  dfont cap extended family wIosevka

else
  version 15x
  # desktop fonts
  dfont
  dfont proof
  dfont menu
fi

# vim: set ft=sh: #
